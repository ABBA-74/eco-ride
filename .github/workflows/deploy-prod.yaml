name: Deploy Ecoride Production

on:
    workflow_dispatch: # manual trigger only

env:
    DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ecoride
    CONTAINER_NAME: ecoride_app
    APP_ENV: prod
    APP_DEBUG: 0

jobs:
    # ---------------------------------------------
    # 1. BUILD JOB (build assets, composer, docker)
    # ---------------------------------------------
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: üêò Setup PHP 8.4
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.4"
                  extensions: mbstring, intl, pdo_pgsql
                  coverage: none

            - name: üß© Install Composer dependencies
              run: composer install --no-dev --optimize-autoloader --no-interaction

            - name: üßπ Clear Symfony prod cache
              run: php bin/console cache:clear --env=prod --no-interaction

            - name: üì¶ Compile Symfony asset mapper
              run: php bin/console asset-map:compile

            - name: üîê Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: üê≥ Build Docker image (prod)
              run: docker build --target=prod -t $DOCKER_IMAGE:latest .

            - name: üì§ Push Docker image
              run: docker push $DOCKER_IMAGE:latest

    # ---------------------------------------------
    # 2. DEPLOY JOB (ssh on VPS + docker run)
    # ---------------------------------------------
    deploy:
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: üöÄ Deploy on VPS via SSH
              uses: appleboy/ssh-action@v1.2.2
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_PRIVATE_KEY }}
                  script: |
                      docker pull $DOCKER_IMAGE:latest
                      docker stop $CONTAINER_NAME || true
                      docker rm $CONTAINER_NAME || true
                      docker run -d --name $CONTAINER_NAME \
                        -e APP_ENV=prod \
                        -e APP_DEBUG=0 \
                        -p 9000:80 \
                        $DOCKER_IMAGE:latest

    # ---------------------------------------------
    # 3. SLACK NOTIFICATION JOB
    # ---------------------------------------------
    notify:
        runs-on: ubuntu-latest
        needs: deploy

        steps:
            - name: üîî Slack notification (production)
              if: ${{ always() }}
              uses: slackapi/slack-github-action@v1.24.0
              with:
                  payload: |
                      {
                        "channel": "${{ secrets.SLACK_CHANNEL_ID }}",
                        "text": ":red_circle: *üö® D√©ploiement PRODUCTION termin√© !*\n\n:rocket: *Projet* : `Ecoride`\n:factory: *Environnement* : `production`\n:bust_in_silhouette: *D√©clench√© par* : `${{ github.actor }}`\n:link: *Voir le run* : <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}>\n:page_with_curl: *Commit* : <https://github.com/${{ github.repository }}/commit/${{ github.sha }}>\n\n*Statut* : `${{ job.status }}`\n\n:warning: _Merci de v√©rifier que tout fonctionne comme pr√©vu._"
                      }
              env:
                  SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
