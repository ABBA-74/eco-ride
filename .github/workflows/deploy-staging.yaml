name: Deploy Ecoride Staging

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

env:
    APP_ENV: staging
    APP_DEBUG: 0
    LOAD_FIXTURES: ${{ secrets.LOAD_FIXTURES }}

    # üê≥ Docker
    DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
    DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/ecoride
    CONTAINER_NAME: ${{ secrets.CONTAINER_NAME_STAGING }}

    # üîê DB (staging)
    DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
    POSTGRES_DB: ${{ secrets.POSTGRES_DB_STAGING }}
    POSTGRES_USER: ${{ secrets.POSTGRES_USER_STAGING }}
    POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD_STAGING }}

    # ‚öôÔ∏è VPS
    VPS_HOST: ${{ secrets.VPS_HOST }}
    VPS_USER: ${{ secrets.VPS_USER }}
    VPS_PRIVATE_KEY: ${{ secrets.VPS_PRIVATE_KEY }}

    # üîî Slack
    SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
    SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

    # üîê App secrets
    MAILER_DSN: ${{ secrets.MAILER_DSN }}
    JWT_PASSPHRASE: ${{ secrets.JWT_PASSPHRASE }}
    CORS_ALLOW_ORIGIN: ${{ secrets.CORS_ALLOW_ORIGIN }}

jobs:
    # ---------------------------------------------
    # 1Ô∏è‚É£ TEST JOB
    # ---------------------------------------------
    tests:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_DB: testdb
                    POSTGRES_USER: test
                    POSTGRES_PASSWORD: test
                ports:
                    - 5432:5432

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: üêò Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.4"
                  extensions: mbstring, intl, pdo_pgsql
                  coverage: none

            - name: üß© Install Composer
              run: composer install --no-progress --prefer-dist --no-scripts

            - name: üì¶ Install importmap vendor assets
              run: php bin/console importmap:install

            - name: üì¶ Compile asset mapper
              run: php bin/console asset-map:compile --env=test

            - name: üóÑÔ∏è Create database (test)
              run: php bin/console doctrine:database:create --if-not-exists --env=test

            - name: üöß Run migrations (test)
              run: php bin/console doctrine:migrations:migrate --env=test --no-interaction

            - name: üì• Load fixtures (test)
              if: env.LOAD_FIXTURES == 'true'
              run: php bin/console doctrine:fixtures:load --env=test --no-interaction
              env:
                LOAD_FIXTURES: ${{ env.LOAD_FIXTURES }}

            - name: ‚úÖ Run PHPUnit tests (TestDox)
              run: php bin/phpunit --testdox

    # ---------------------------------------------
    # 2Ô∏è‚É£ BUILD JOB
    # ---------------------------------------------
    build:
        runs-on: ubuntu-latest
        needs: tests

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: üîê Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ env.DOCKERHUB_USERNAME }}
                  password: ${{ env.DOCKERHUB_TOKEN }}

            - name: üê≥ Build Docker image (staging)
              run: docker build --no-cache --target=prod -t $DOCKER_IMAGE:latest .

            - name: üì§ Push Docker image
              run: docker push $DOCKER_IMAGE:latest

    # ---------------------------------------------
    # 3Ô∏è‚É£ DEPLOY JOB
    # ---------------------------------------------
    deploy:
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: üì• Checkout repository
              uses: actions/checkout@v4

            - name: üì¶ Prepare deploy script
              run: |
                # Move the script to the root temporarily to avoid recreating the .github/ folder on the VPS
                mv .github/scripts/deploy-staging.sh deploy-staging.sh

            - name: üß± Ensure scripts directory exists on VPS
              uses: appleboy/ssh-action@v1.2.2
              with:
                host: ${{ env.VPS_HOST }}
                username: ${{ env.VPS_USER }}
                key: ${{ env.VPS_PRIVATE_KEY }}
                script: |
                  mkdir -p /var/www/ecoride/scripts

            - name: üìÇ Copy deploy script to VPS
              uses: appleboy/scp-action@v0.1.7
              with:
                host: ${{ env.VPS_HOST }}
                username: ${{ env.VPS_USER }}
                key: ${{ env.VPS_PRIVATE_KEY }}
                source: "deploy-staging.sh"
                target: "/var/www/ecoride/scripts/"
                overwrite: true

            - name: üì¶ Generate .env.staging on VPS
              uses: appleboy/ssh-action@v1.2.2
              with:
                host: ${{ env.VPS_HOST }}
                username: ${{ env.VPS_USER }}
                key: ${{ env.VPS_PRIVATE_KEY }}
                script: |
                  echo "DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}" > /var/www/ecoride/.env.staging
                  echo "APP_ENV=staging" >> /var/www/ecoride/.env.staging
                  echo "APP_DEBUG=0" >> /var/www/ecoride/.env.staging
                  echo "APP_SECRET=${{ secrets.APP_SECRET }}" >> /var/www/ecoride/.env.staging
                  echo "MAILER_DSN=${{ secrets.MAILER_DSN }}" >> /var/www/ecoride/.env.staging
                  echo "JWT_PASSPHRASE=${{ secrets.JWT_PASSPHRASE }}" >> /var/www/ecoride/.env.staging
                  echo "CORS_ALLOW_ORIGIN=${{ secrets.CORS_ALLOW_ORIGIN }}" >> /var/www/ecoride/.env.staging

            - name: üöÄ Run deploy script on VPS
              uses: appleboy/ssh-action@v1.2.2
              with:
                host: ${{ env.VPS_HOST }}
                username: ${{ env.VPS_USER }}
                key: ${{ env.VPS_PRIVATE_KEY }}
                script: |
                  cd /var/www/ecoride/scripts/
                  chmod +x deploy-staging.sh

                  DOCKER_IMAGE="${{ env.DOCKER_IMAGE }}" \
                  CONTAINER_NAME="${{ env.CONTAINER_NAME }}" \
                  LOAD_FIXTURES="${{ env.LOAD_FIXTURES }}" \
                  ./deploy-staging.sh

    # ---------------------------------------------
    #  4Ô∏è‚É£ SLACK NOTIFICATION JOB
    # ---------------------------------------------
    notify:
        runs-on: ubuntu-latest
        needs: deploy

        steps:
            - name: üîî Slack notification (staging)
              if: ${{ always() }}
              uses: slackapi/slack-github-action@v1.24.0
              with:
                  payload: |
                      {
                        "channel": "${{ env.SLACK_CHANNEL_ID }}",
                        "text": ":construction: *D√©ploiement STAGING termin√©*\n\n:rocket: *Projet* : `Ecoride`\n:computer: *Environnement* : `staging`\n:technologist: *D√©clench√© par* : `${{ github.actor }}`\n:scroll: *Commit* : <https://github.com/${{ github.repository }}/commit/${{ github.sha }}>\n:clipboard: *Statut* : `${{ job.status }}`\n\n:white_check_mark: _Tests lanc√©s automatiquement avant d√©ploiement._"
                      }
              env:
                  SLACK_BOT_TOKEN: ${{ env.SLACK_BOT_TOKEN }}
